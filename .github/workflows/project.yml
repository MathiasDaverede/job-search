name: Project

# Run GitHub Actions only on pull requests to stay within the free plan limits (500 MB storage, 2000 minutes/month).
# Pull requests to 'develop' are for feature branches.
# Pull requests to 'main' are for release or hotfix branches.
on:
  pull_request:
    branches: [main, develop]

permissions:
  contents: read # Allows reading repository contents (e.g., for checkout and file access)
  pull-requests: read # For fetching pull request data via GitHub API
  actions: write  # Necessary to trigger another workflow via workflow_dispatch

jobs:
  test-project:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create .env.local with host data
      run: |
        file_content="USER_NAME=$(whoami)\n"
        file_content+="USER_ID=$(id -u)\n"
        file_content+="GROUP_ID=$(id -g)\n"
        file_content+="MARIADB_DATABASE_NAME=job_search\n"
        file_content+="MARIADB_ROOT_PASSWORD=root"
        echo -e $file_content > .env.local

    - name: Display .env.local
      run: cat .env.local

    - name: Build and start containers
      run: docker compose --env-file .env.local up -d

    - name: Check containers status
      run: |
        docker ps -a
        docker logs job-search-web-1

    - name: Verify host's rights
      run: |
        echo "$(whoami) $(id -u) $(id -g)"
        ls -l 
        echo "Executables files :"
        ls -l bin/

    - name: Verify container's rights in /var/www/
      run: |
        echo "$(docker compose exec web whoami) $(docker compose exec web id -u) $(docker compose exec web id -g)"
        docker compose exec web ls -l /var/ | grep www
        docker compose exec web ls -l /var/www/
        echo  "Executables files :"
        docker compose exec web ls -l /var/www/bin/

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-

    - name: Cache Importmap dependencies
      uses: actions/cache@v4
      with:
        path: assets/vendor
        key: importmap-${{ hashFiles('importmap.php') }}
        restore-keys: importmap-

    - name: Install Composer dependencies
      run: docker compose exec web composer install --no-interaction --optimize-autoloader
      
    - name: Run Doctrine migrations
      run: docker compose exec web bin/console doctrine:migrations:migrate --no-interaction

    - name: Cache Sass assets
      uses: actions/cache@v4
      with:
        path: var/sass
        key: sass-${{ hashFiles('assets/**/*.scss') }}
        restore-keys: sass-

    - name: Generate Sass assets
      run: docker compose exec web bin/console sass:build

    - name: Check Composer platform requirements
      run: docker compose exec web composer check-platform-reqs

    - name: Check Symfony requirements
      run: docker compose exec web symfony check:requirements

    - name: Check Symfony security issues in project dependencies
      run: docker compose exec web symfony check:security

    - name: Audit importmap
      run: docker compose exec web bin/console importmap:audit

    - name: Unit tests
      run: |
        chmod +x ./bin/phpunit
        docker compose exec web bin/console --env=test doctrine:database:create
        docker compose exec web bin/console --env=test doctrine:schema:create
        docker compose exec web bin/console --env=test doctrine:fixtures:load --no-interaction
        docker compose exec web bin/phpunit

    - name: Trigger version-changelog.yml workflow
      if: github.event.pull_request.base.ref == 'main' # Only for releases or hotfixes
      # Runs only if all previous steps succeed, triggering version-changelog.yml for main branch PRs.
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.PAT_REPO_WORKFLOW }}
        script: |
          console.log("Owner: ", context.repo.owner);
          console.log("Repo: ", context.repo.repo);
          console.log("Workflow ID: ", 'version-changelog.yml');
          console.log("Ref: ", context.payload.pull_request.head.ref);
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'version-changelog.yml',
              ref: context.payload.pull_request.head.ref
            });
            console.log("Workflow dispatch triggered successfully");
          } catch (error) {
            console.error("Error triggering workflow:", error);
            core.setFailed(`Failed to trigger workflow: ${error.message}`);
          }
