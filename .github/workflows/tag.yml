name: Tag

# Triggered after merging PRs to main from release/X.Y.Z or hotfix/X.Y.Z branches.
on:
  pull_request:
    branches: [main]
    types: [closed] # PR merged

permissions:
  contents: write # For creating and pushing tags and releases
  pull-requests: read # For accessing PR branch name
  issues: read # For rendering issue links in release notes

jobs:
  create-tag:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch history to analyse tags and commits
          ref: main

      - name: Extract version from VERSION.md
        run: |
          version=$(cat VERSION.md)
          echo "NEW_VERSION=$version" >> $GITHUB_ENV

      - name: Create tag
        run: |
          git tag ${{ env.NEW_VERSION }}
          git push origin ${{ env.NEW_VERSION }}

      - name: Set up GitHub CLI
        run: |
          gh version || (echo "Installing GitHub CLI..." && sudo apt-get update && sudo apt-get install -y gh)

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ env.NEW_VERSION }} --title "${{ env.NEW_VERSION }}" --notes-file CHANGELOG.md --target main
